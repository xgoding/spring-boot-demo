<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        .main-block {
            padding: 10px;
        }

        .block-header {
            font-size: 15px;
            font-weight: bold;
        }

        .block-body {
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div id="app">
    <el-container>
        <!--布局头部信息-->
        <el-header>
            <div class="main-block">
                <div class="block-header"><span>控制开关</span></div>
                <div class="block-body">
                    <el-button @click="handConnect" type="primary" :disabled="isConnected" size="small">手动连接</el-button>
                    <el-button @click="disconnect" type="danger" :disabled="!isConnected" size="small">断开连接</el-button>
                </div>
            </div>
        </el-header>
        <el-main>
            <!--端点类型-->
            <div class="main-block">
                <div class="block-header"><span>消息端点类型</span></div>
                <div class="block-body">
                    <el-radio-group v-model="messageType" size="small" @change="messageTypeChange">
                        <el-radio-button label="generic">泛型消息端点</el-radio-button>
                        <el-radio-button label="text">文本消息端点</el-radio-button>
                        <el-radio-button label="decorator">文本消息端点（装饰器）</el-radio-button>
                        <el-radio-button label="binary">二进制消息端点</el-radio-button>
                    </el-radio-group>
                </div>
            </div>

            <!--内容区域-->
            <div class="main-block">
                <div class="block-header"><span>消息内容</span></div>
                <div class="block-body">
                    <el-input v-model="message" placeholder="请输入发送的内容"></el-input>
                    <el-button @click="sendMessage" type="primary" :disabled="!isConnected">发送消息</el-button>
                </div>
            </div>

            <!--相应消息-->
            <div class="main-block">
                <div class="block-header"><span>服务器响应</span></div>
                <div class="block-body" style="height: 500px">
                    <el-table :data="msgDatas" stripe max-height="500" size="small" :border="true">
                        <el-table-column
                                prop="time"
                                label="时间"
                                width="200">
                        </el-table-column>
                        <el-table-column
                                prop="content"
                                label="内容">
                        </el-table-column>
                    </el-table>
                </div>
            </div>

        </el-main>
    </el-container>
</div>
</body>
<script src="https://cdn.bootcss.com/vue/2.5.21/vue.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.14.0/index.min.js"></script>
<script>
    //泛型消息端点
    const wsGenericEndpoint = "ws://localhost:8080/demo/myHandler";
    //文本消息端点
    const wsTextEndpoint = "ws://localhost:8080/demo/myTextHandler";
    //二进制端点
    const wsBinaryEndpoint = "ws://localhost:8080/demo/myBinaryHandler";
    //文本消息端点（装饰器）
    const wsDecoratorTextEndpoint = "ws://localhost:8080/demo/myDecoratorTextHandler";

    var app = new Vue({
        el: "#app",
        data: function () {
            return {
                //连接状态
                isConnected: false,
                //消息实体
                message: null,
                //websocket对象
                ws: null,
                //消息类型
                messageType: 'generic',
                //服务器消息列表
                msgDatas: []
            };
        },
        methods: {
            /**
             * 手动连接
             */
            handConnect() {
                var that = this;
                if (this.isConnected) {
                    that.$message.error('不能重复连接');
                    return;
                }
                //创建websocket对象
                let endpoint;
                switch (this.messageType) {
                    case "generic":
                        endpoint = wsGenericEndpoint;
                        break;
                    case "text":
                        endpoint = wsTextEndpoint;
                        break
                    case "binary":
                        endpoint = wsBinaryEndpoint;
                        break
                    case "decorator":
                        endpoint = wsDecoratorTextEndpoint;
                        break;
                    default:
                        endpoint = wsGenericEndpoint;
                }
                this.ws = new WebSocket(endpoint);
                //监听连接状态
                this.ws.onopen = function (event) {
                    that.isConnected = true;
                    that.$message.success('连接成功');
                }
                //监听连接错误
                this.ws.onerror = function (event) {
                    that.$message.error('发生错误');
                    that.msgDatas.push({time: event.timeStamp, content: event.reason});
                    console.log('WebSocket error occur', event);
                }
                //监听消息
                this.ws.onmessage = function (event) {
                    that.$message.info('收到消息');
                    console.log("WebSocket message received", event);
                    that.msgDatas.push(JSON.parse(event.data));
                };
                //监听关闭
                this.ws.onclose = function (event) {
                    that.isConnected = false;
                    that.$message.info("连接断开");
                    that.msgDatas.push({time: event.timeStamp, content: event.reason});
                    console.log("WebSocket disconnect", event);
                };
            },
            /**
             * 消息类型改变
             */
            messageTypeChange(value) {
                if (this.isConnected) {
                    this.disconnect();
                }
                this.handConnect();
            },
            /**
             * 断开连接
             */
            disconnect() {
                if (!this.isConnected) {
                    this.$message.error("连接已关闭，无法关闭！");
                    return;
                }
                this.isConnected = false;
                this.ws.close(1000, "手动关闭");
            },
            /**
             * 发送文本消息
             */
            sendMessage() {
                this.ws.send(this.message);
                this.$message.info("消息发送成功！");
            },
            /**
             * 发送ping/pong消息
             */
            sendPingPong() {
                //There is no javascript API to send ping frames or receive pongs frame.
                //https://stackoverflow.com/questions/10585355/sending-websocket-ping-pong-frame-from-browser
            }
        },
        mounted() {
            this.handConnect();
        },
        beforeDestroy() {
            this.disconnect();
        }
    });
</script>
</html>